"use strict";const e=require("electron"),s=require("path"),m=require("fs/promises"),p=require("os");async function b(t,a,d){let n=new e.BrowserWindow({frame:!1,fullscreen:!t,width:a,height:d,x:0,y:0,transparent:!0,resizable:!1,movable:!1,autoHideMenuBar:!0,enableLargerThanScreen:!0,skipTaskbar:!0,alwaysOnTop:!0,hasShadow:!1,webPreferences:{webSecurity:!1,nodeIntegration:!1,contextIsolation:!0,preload:s.join(__dirname,"preload.js")}});return n.setOpacity(1),n.setAlwaysOnTop(!0,"screen-saver"),n.setFullScreenable(!1),n.setVisibleOnAllWorkspaces(!0),n.on("closed",()=>{n=null}),await n.loadFile(s.join(__dirname,"../electron/captureWindow/capture.html")),n}const S=p.platform()==="darwin";process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true";let o,r,c,l,i;const w=()=>{o=new e.BrowserWindow({frame:!1,width:450,height:600,webPreferences:{webSecurity:!1,nodeIntegration:!1,contextIsolation:!0,preload:s.join(__dirname,"../dist-electron/preload.js")}}),process.env.VITE_DEV_SERVER_URL?o.loadURL(process.env.VITE_DEV_SERVER_URL):o.loadFile(s.join(__dirname,"../dist/index.html"))};e.app.whenReady().then(()=>{I(),w(),E(),e.app.on("activate",()=>{e.BrowserWindow.getAllWindows().length===0&&w()});const{size:t,scaleFactor:a}=e.screen.getPrimaryDisplay();c=t.width,l=t.height,i=a});e.app.on("window-all-closed",()=>{process.platform!=="darwin"&&e.app.quit()});async function u(){r=await b(S,c,l)}async function _(){return await e.desktopCapturer.getSources({types:["screen"],thumbnailSize:{width:c*i,height:l*i}})}function v(t){const a=e.nativeImage.createFromDataURL(t);e.clipboard.writeImage(a)}async function y(t){try{if(!r)return;const a=t.match(/^data:image\/(\w+);base64,(.+)$/);if(!a)throw new Error("Invalid data URL");const[,d,n]=a,h=Buffer.from(n,"base64"),{filePath:f,canceled:g}=await e.dialog.showSaveDialog(r,{title:"Download Image",defaultPath:`FengCh-${Date.now()}.${d}`});if(g){r.close();return}await m.writeFile(f,h),r.close()}catch(a){throw a}}function I(){e.ipcMain.handle("screen:shot",u),e.ipcMain.handle("window:close",()=>{console.log("close mainWindow success!"),o==null||o.close()}),e.ipcMain.handle("captureWindow:close",()=>{console.log("close captureWindow success!"),r==null||r.close()}),e.ipcMain.handle("captureWindow:sources",_),e.ipcMain.handle("screen:sources",()=>(console.log("get screen:sources success!"),{screenMaxWidth:c,screenMaxHeight:l,screenScaleFactor:i})),e.ipcMain.handle("saveClipboard:image",(t,a)=>{console.log("saveClipboard:image success!"),v(a)}),e.ipcMain.handle("download:image",(t,a)=>{y(a)})}function E(){p.platform()==="darwin"?e.globalShortcut.register("Command+P",()=>{u()}):e.globalShortcut.register("Ctrl+P",()=>{u()})}
